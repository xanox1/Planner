<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routine planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body {
            background: linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%);
            font-family: 'Manrope', system-ui, -apple-system, sans-serif;
        }
        .task-row:hover .action-btns { opacity: 1; }
        .completed { background-color: #f8fafc; color: #94a3b8; }
        .completed .task-text { text-decoration: line-through; }
        .badge-habit { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .badge-focus { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .badge-clean { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .badge-small { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .badge-relationship { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .drag-handle { cursor: grab; color: #cbd5e1; }
        .drag-handle:active { cursor: grabbing; }
        .sortable-ghost { opacity: 0.3; background: #e2e8f0; }
        .modal-backdrop { background: rgba(15, 23, 42, 0.6); }
        .overlap td { background-color: #fee2e2; }
        .checkmark {
            width: 28px;
            height: 28px;
            border-radius: 10px;
            border: 2px solid #cbd5e1;
            background: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: inset 0 0 0 0 rgba(99, 102, 241, 0.2);
        }
        .checkmark svg { opacity: 0; transform: scale(0.6); transition: all 0.2s ease; }
        .check-input:checked + .checkmark {
            background: #4f46e5;
            border-color: #4f46e5;
            box-shadow: 0 6px 14px rgba(79, 70, 229, 0.25);
        }
        .check-input:checked + .checkmark svg { opacity: 1; transform: scale(1); color: white; }
        .check-label { cursor: pointer; }
        .check-input:focus-visible + .checkmark { outline: 2px solid #a5b4fc; outline-offset: 2px; }
        .gap-row td { background-color: #f1f5f9; color: #64748b; font-style: italic; }
        .timeline-dot {
            position: absolute;
            left: -5px;
            width: 12px;
            height: 12px;
            border-radius: 999px;
            border: 2px solid white;
            box-shadow: 0 0 0 2px rgba(226, 232, 240, 1);
        }
        .timeline-item {
            position: absolute;
            left: -6px;
            transform: translateY(-50%);
            pointer-events: auto;
        }
        .timeline-item .timeline-dot {
            position: static;
            box-shadow: 0 0 0 2px rgba(226, 232, 240, 1);
            cursor: pointer;
        }
        .balance-chart {
            width: 148px;
            height: 148px;
            border-radius: 999px;
            background: conic-gradient(#e2e8f0 0deg, #e2e8f0 360deg);
            border: 8px solid #f8fafc;
            box-shadow: inset 0 0 0 1px #e2e8f0;
        }
        .balance-swatch {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            display: inline-block;
            box-shadow: 0 0 0 2px rgba(226, 232, 240, 0.8);
        }
        .timeline-cap {
            position: absolute;
            left: -6px;
            width: 14px;
            height: 14px;
            border-radius: 999px;
            border: 2px solid white;
            background: #cbd5e1;
            box-shadow: 0 0 0 2px rgba(226, 232, 240, 1);
        }
        .timeline-hour {
            position: absolute;
            left: 0;
            transform: translateY(-50%);
            font-size: 10px;
            font-weight: 700;
            color: #94a3b8;
            letter-spacing: 0.08em;
        }
        .timeline-balloon {
            left: 18px;
        }
        .sleep-mode {
        }
        .sleep-overlay {
            position: absolute;
            inset: 0;
            opacity: 0;
            pointer-events: none;
            z-index: 3;
            transition: opacity 0.4s ease;
        }
        .sleep-mode .sleep-overlay {
            opacity: 1;
        }
        .sleep-sky {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.9) 70%);
        }
        .sleep-stars {
            position: absolute;
            inset: 0;
            background-image:
                radial-gradient(circle, rgba(255, 255, 255, 0.9) 1px, transparent 2px),
                radial-gradient(circle, rgba(255, 255, 255, 0.6) 1px, transparent 2px),
                radial-gradient(circle, rgba(255, 255, 255, 0.75) 1px, transparent 2px);
            background-size: 120px 120px, 180px 180px, 240px 240px;
            background-position: 20px 10px, 80px 40px, 40px 90px;
            animation: starTwinkle 6s ease-in-out infinite;
            mix-blend-mode: screen;
        }
        .sleep-moon {
            position: relative;
            width: 84px;
            height: 84px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #e2e8f0 70%);
            box-shadow: 0 0 24px rgba(255, 255, 255, 0.6);
            animation: moonFloat 5s ease-in-out infinite;
        }
        .sleep-moon::before {
            content: '';
            position: absolute;
            left: 26px;
            top: 36px;
            width: 10px;
            height: 3px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.8);
            box-shadow: 22px 0 0 rgba(148, 163, 184, 0.8);
        }
        .sleep-zzz {
            position: absolute;
            left: 58px;
            top: -8px;
            font-size: 29px;
            font-weight: 700;
            letter-spacing: 0.12em;
            color: rgba(248, 250, 252, 0.7);
            width: 72px;
            height: 46px;
            text-align: left;
            line-height: 1;
            white-space: nowrap;
        }
        .sleep-indicator {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 84px;
            height: 84px;
        }
        .sleep-zzz span {
            position: absolute;
            inset: 0;
            width: 100%;
            opacity: 0;
            animation: zzzDrift 4.5s ease-in-out infinite;
            animation-fill-mode: both;
            transform-origin: left center;
        }
        .sleep-zzz span:nth-child(2) {
            animation-delay: 2.05s;
        }
        .sleep-zzz span {
            --dx: 36px;
            --dy: -28px;
            --s0: 0.7;
            --s1: 1.35;
        }
        @keyframes starTwinkle {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        @keyframes moonFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        @keyframes zzzDrift {
            0% { opacity: 0; transform: translate(0, 0) scale(0.6); }
            15% { opacity: 1; transform: translate(10px, -8px) scale(0.8); }
            45% { opacity: 1; transform: translate(24px, -18px) scale(1.05); }
            70% { opacity: 0.8; transform: translate(40px, -30px) scale(1.3); }
            100% { opacity: 0; transform: translate(52px, -40px) scale(1.45); }
        }
        .admin-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            height: 32px;
            padding: 0 10px;
            border-radius: 999px;
            border: 1px solid #6c8087;
            background: #6c8087;
            color: #ffffff;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        .admin-btn:hover { background: #5a6c72; border-color: #5a6c72; }
        .admin-btn--ghost {
            background: transparent;
            color: #6c8087;
            border-color: #9fb0b6;
        }
        .admin-btn--ghost:hover { background: #e8eef0; color: #5a6c72; }
        .admin-btn--icon { width: 32px; padding: 0; justify-content: center; }
        .admin-icon { width: 14px; height: 14px; }
        .admin-hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .admin-float { position: absolute; right: 0; top: 0; }
        .admin-toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
            flex-shrink: 0;
            flex-direction: row-reverse;
        }
        .fade-up { animation: fadeUp 0.6s ease both; }
        .fade-up-delay { animation-delay: 0.12s; }
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="h-screen overflow-hidden">

    <div class="h-full p-4 md:p-8">
    <div class="max-w-6xl mx-auto h-full">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-stretch h-full">
            <aside class="md:col-span-4 self-stretch flex flex-col gap-6">
                <div id="timelineSection" class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 fade-up flex-1 flex flex-col relative">
                    <div class="sleep-overlay">
                        <div class="sleep-sky"></div>
                        <div class="sleep-stars"></div>
                        <div class="sleep-indicator">
                            <div class="sleep-moon"></div>
                            <div class="sleep-zzz">
                                <span>Z</span>
                                <span>Z</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 flex-1">
                        <div class="relative h-full min-h-[420px]" id="timelineBody">
                            <div class="absolute left-4 top-4 bottom-4 w-px bg-slate-200"></div>
                            <div id="timelineHours" class="absolute -left-2 top-4 bottom-4 w-14"></div>
                            <div id="timelineDots" class="absolute left-4 top-4 bottom-4 w-px">
                                <div id="timelineItems" class="relative h-full"></div>
                            </div>
                            <div class="timeline-cap" style="bottom: 10px;"></div>
                            <div id="timelineBalloon" class="timeline-balloon absolute -translate-y-1/2">
                                <div class="relative rounded-2xl border border-indigo-100 bg-white px-4 py-3 shadow-sm">
                                    <span class="absolute -left-2 top-1/2 h-3 w-3 -translate-y-1/2 rotate-45 border border-indigo-100 bg-white"></span>
                                    <div class="flex items-center gap-3">
                                        <span id="timelineBalloonDot" class="h-2.5 w-2.5 rounded-full bg-indigo-500"></span>
                                        <div>
                                            <div id="timelineBalloonName" class="text-sm font-semibold text-slate-800">Geen actieve taak</div>
                                            <div id="timelineBalloonTime" class="text-xs text-slate-500"></div>
                                            <div id="timelineBalloonType" class="text-[11px] font-semibold uppercase tracking-widest text-slate-400"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 flex-shrink-0 flex flex-col">
                    <div class="bg-slate-50 px-6 py-3 border-b border-slate-200 flex items-center justify-between gap-4">
                        <div>
                            <h2 class="text-sm font-semibold text-slate-600 uppercase tracking-wider">Balans</h2>
                        </div>
                    </div>
                    <div class="px-6 py-4 flex items-center gap-5">
                        <div id="balanceChart" class="balance-chart" aria-label="Balance chart"></div>
                        <div id="balanceLegend" class="flex-1 space-y-2"></div>
                    </div>
                </div>
            </aside>

            <div class="md:col-span-8 h-full flex flex-col gap-6 min-h-0">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 fade-up fade-up-delay flex flex-col min-h-0 flex-1">
                    <!-- Header -->
                    <div class="bg-[#6c8087] p-8 text-white">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 class="text-3xl font-extrabold tracking-tight">Routine planner</h1>
                                <div class="mt-2 flex items-center gap-2">
                                    <p class="text-indigo-100 opacity-90 italic" id="quoteDisplay">Inspiratie wordt geladen...</p>
                                    <button onclick="loadQuote()" class="w-6 h-6 inline-flex items-center justify-center rounded-full bg-[#6c8087] hover:bg-[#5a6c72] border border-[#9fb0b6]" aria-label="Nieuwe quote" title="Nieuwe quote">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5 text-white">
                                            <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.186 2.36.75.75 0 00-1.06 1.06 7 7 0 0011.682-3.002h1.702a.75.75 0 00.53-1.28l-2.5-2.5a.75.75 0 00-1.06 0l-2.5 2.5a.75.75 0 00.53 1.28h1.362zM4.688 8.576a5.5 5.5 0 019.186-2.36.75.75 0 001.06-1.06A7 7 0 003.252 8.158H1.55a.75.75 0 00-.53 1.28l2.5 2.5a.75.75 0 001.06 0l2.5-2.5a.75.75 0 00-.53-1.28H4.688z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="flex flex-col items-end">
                                <p class="text-lg font-medium" id="dateDisplay"></p>
                                <div class="admin-toolbar mt-2">
                                    <button id="actionsToggle" onclick="toggleConfigPanel()" class="admin-btn admin-btn--icon" aria-label="Configuratie" title="Configuratie">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="admin-icon">
                                            <path fill-rule="evenodd" d="M11.078 2.25c-.217 0-.433.033-.646.1l-1.13.354a.75.75 0 00-.503.7V4.1a6.992 6.992 0 00-1.732.999l-.68-.392a.75.75 0 00-.868.107l-.822.822a.75.75 0 00-.107.868l.392.68a6.992 6.992 0 00-1 1.732H3.7a.75.75 0 00-.7.503l-.354 1.13a1.75 1.75 0 000 1.002l.354 1.13a.75.75 0 00.7.503h.698c.23.64.567 1.24 1 1.732l-.392.68a.75.75 0 00.107.868l.822.822a.75.75 0 00.868.107l.68-.392a6.992 6.992 0 001.732.999v.698a.75.75 0 00.503.7l1.13.354c.323.1.679.1 1.002 0l1.13-.354a.75.75 0 00.503-.7v-.698a6.992 6.992 0 001.732-.999l.68.392a.75.75 0 00.868-.107l.822-.822a.75.75 0 00.107-.868l-.392-.68a6.992 6.992 0 001-1.732h.698a.75.75 0 00.7-.503l.354-1.13c.1-.323.1-.679 0-1.002l-.354-1.13a.75.75 0 00-.7-.503h-.698a6.992 6.992 0 00-1-1.732l.392-.68a.75.75 0 00-.107-.868l-.822-.822a.75.75 0 00-.868-.107l-.68.392a6.992 6.992 0 00-1.732-.999V3.404a.75.75 0 00-.503-.7l-1.13-.354a1.74 1.74 0 00-.356-.1zM10 7.25a2.75 2.75 0 100 5.5 2.75 2.75 0 000-5.5z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <button onclick="openCategoryModal()" class="admin-btn admin-btn--icon admin-btn--ghost admin-only admin-hidden" aria-label="Type beheren" title="Type beheren">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="admin-icon">
                                            <path d="M13.586 2.586a2 2 0 012.828 2.828l-8.5 8.5a1 1 0 01-.39.242l-3 1a1 1 0 01-1.262-1.262l1-3a1 1 0 01.242-.39l8.5-8.5z" />
                                            <path d="M11.5 4.5l4 4" />
                                        </svg>
                                    </button>
                                    <button onclick="exportTasks()" class="backup-action admin-btn admin-btn--icon admin-hidden" aria-label="Back-up downloaden" title="Back-up downloaden">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="admin-icon">
                                            <path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v6.19l1.72-1.72a.75.75 0 111.06 1.06l-3 3a.75.75 0 01-1.06 0l-3-3a.75.75 0 111.06-1.06l1.72 1.72V3.75A.75.75 0 0110 3zM4.5 13.5a.75.75 0 01.75-.75h9.5a.75.75 0 010 1.5h-9.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <button onclick="document.getElementById('importFile').click()" class="backup-action admin-btn admin-btn--icon admin-hidden" aria-label="Back-up inladen" title="Back-up inladen">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="admin-icon">
                                            <path fill-rule="evenodd" d="M10 17a.75.75 0 01-.75-.75V9.81l-1.72 1.72a.75.75 0 11-1.06-1.06l3-3a.75.75 0 011.06 0l3 3a.75.75 0 11-1.06 1.06l-1.72-1.72v6.44A.75.75 0 0110 17zM4.5 6.5a.75.75 0 01.75-.75h9.5a.75.75 0 010 1.5h-9.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importTasks(event)">
                                </div>
                            </div>
                        </div>
                        </div>

                        <div class="p-6 md:p-8 flex flex-col min-h-0 flex-1">
                <!-- Task Input Form -->
                <div id="addTaskPanel" class="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-6 hidden">
                    <h2 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">Nieuwe taak toevoegen</h2>
                    <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
                        <div class="md:col-span-1">
                            <label class="block text-xs font-bold text-slate-700 mb-1">TIJD</label>
                            <input type="time" id="taskTime" class="w-full rounded-lg border-slate-300 p-2 border text-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-slate-700 mb-1">ACTIVITEIT</label>
                            <input type="text" id="taskName" placeholder="Bijv. Wandelen" class="w-full rounded-lg border-slate-300 p-2 border text-sm">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs font-bold text-slate-700 mb-1">DUUR (MIN)</label>
                            <input type="number" id="taskDuration" placeholder="30" class="w-full rounded-lg border-slate-300 p-2 border text-sm">
                        </div>
                        <div class="md:col-span-2">
                            <div class="flex items-center">
                                <label class="block text-xs font-bold text-slate-700 mb-1">TYPE</label>
                            </div>
                            <select id="taskType" class="w-full rounded-lg border-slate-300 p-2 border text-sm"></select>
                        </div>
                        <div class="md:col-span-1 flex items-end justify-end">
                            <button onclick="addTask()" class="admin-btn admin-btn--icon" aria-label="Taak toevoegen" title="Taak toevoegen" style="width: 40px; height: 40px;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="admin-icon">
                                    <path fill-rule="evenodd" d="M10 4.5a.75.75 0 01.75.75v4h4a.75.75 0 010 1.5h-4v4a.75.75 0 01-1.5 0v-4h-4a.75.75 0 010-1.5h4v-4A.75.75 0 0110 4.5z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-hidden rounded-xl border border-slate-200 shadow-sm flex-1 min-h-0">
                    <div class="h-full overflow-y-auto overscroll-contain">
                    <table class="min-w-full divide-y divide-slate-200" id="planningTable">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-4 w-10"></th>
                                <th class="px-4 py-4 text-left text-xs font-bold text-slate-500 uppercase">Tijd</th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase">Taak</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-slate-500 uppercase">Duur</th>
                                <th class="px-6 py-4 text-center text-xs font-bold text-slate-500 uppercase">Gereed</th>
                                <th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase actions-col hidden">Acties</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200" id="taskList"></tbody>
                    </table>
                    </div>
                </div>

                <div class="mt-6 flex flex-col md:flex-row justify-between items-center gap-4">
                    <button onclick="resetAllTasks()" class="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition admin-only admin-hidden">Reset Status</button>
                    <span id="saveStatus" class="text-[10px] bg-green-100 text-green-700 px-3 py-1 rounded-full opacity-0 transition-opacity uppercase font-bold tracking-widest">Opgeslagen</span>
                </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 flex-shrink-0 flex flex-col max-h-[18vh] min-h-[96px]">
                    <div class="bg-slate-50 px-6 py-3 border-b border-slate-200 flex items-center justify-between gap-4">
                        <div>
                            <h2 class="text-sm font-semibold text-slate-600 uppercase tracking-wider">Dagelijkse historie</h2>
                        </div>
                        <button onclick="openHistoryModal()" class="admin-btn admin-btn--icon" aria-label="Bekijk historie" title="Bekijk historie">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="admin-icon">
                                <path d="M4.75 3.5A1.75 1.75 0 016.5 1.75h7a1.75 1.75 0 011.75 1.75v13a1.75 1.75 0 01-1.75 1.75h-7A1.75 1.75 0 014.75 16.5v-13z" />
                                <path d="M7 6.25A.75.75 0 017.75 5.5h4.5a.75.75 0 010 1.5h-4.5A.75.75 0 017 6.25zM7 9.25a.75.75 0 01.75-.75h4.5a.75.75 0 010 1.5h-4.5A.75.75 0 017 9.25z" />
                            </svg>
                        </button>
                    </div>
                    <div class="px-6 py-3 flex-1 overflow-y-auto">
                        <div id="historyList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- History Overview Modal -->
    <div id="historyModal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div class="absolute inset-0 modal-backdrop" onclick="closeHistoryModal()"></div>
        <div class="relative bg-white w-full max-w-4xl mx-4 rounded-2xl shadow-2xl border border-slate-200">
            <div class="bg-indigo-700 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between">
                <h3 class="text-lg font-bold">Historie overzicht</h3>
                <button onclick="closeHistoryModal()" class="text-indigo-100 hover:text-white">✕</button>
            </div>
            <div class="p-6">
                <div class="space-y-4" id="historyModalList"></div>
            </div>
        </div>
    </div>

    <!-- History Edit Modal -->
    <div id="historyEditModal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div class="absolute inset-0 modal-backdrop" onclick="closeHistoryEditModal()"></div>
        <div class="relative bg-white w-full max-w-3xl mx-4 rounded-2xl shadow-2xl border border-slate-200">
            <div class="bg-indigo-700 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between">
                <h3 class="text-lg font-bold">Historie bewerken</h3>
                <button onclick="closeHistoryEditModal()" class="text-indigo-100 hover:text-white">✕</button>
            </div>
            <div class="p-6">
                <p class="text-xs text-slate-500 mb-4">Sleep taken tussen links en rechts om ze te corrigeren.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">AFGEVINKT</label>
                        <div id="historyCheckedList" class="min-h-[220px] rounded-lg border border-slate-300 p-2.5 space-y-2 bg-white"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">NIET AFGEVINKT</label>
                        <div id="historyUncheckedList" class="min-h-[220px] rounded-lg border border-slate-300 p-2.5 space-y-2 bg-white"></div>
                    </div>
                </div>
                <div class="mt-6 flex items-center justify-end gap-3">
                    <button onclick="closeHistoryEditModal()" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200">Annuleren</button>
                    <button onclick="saveHistoryEdit()" class="px-5 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700">Opslaan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div class="absolute inset-0 modal-backdrop" onclick="closeEditModal()"></div>
        <div class="relative bg-white w-full max-w-3xl mx-4 rounded-2xl shadow-2xl border border-slate-200">
            <div class="bg-indigo-700 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between">
                <h3 class="text-lg font-bold">Taak bewerken</h3>
                <button onclick="closeEditModal()" class="text-indigo-100 hover:text-white">✕</button>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-slate-700 mb-1">TIJD</label>
                        <input type="time" id="editTaskTime" class="w-full rounded-lg border-slate-300 p-2.5 border">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-slate-700 mb-1">ACTIVITEIT</label>
                        <input type="text" id="editTaskName" class="w-full rounded-lg border-slate-300 p-2.5 border">
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-slate-700 mb-1">DUUR (MIN)</label>
                        <input type="number" id="editTaskDuration" class="w-full rounded-lg border-slate-300 p-2.5 border">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-slate-700 mb-1">TYPE</label>
                        <select id="editTaskType" class="w-full rounded-lg border-slate-300 p-2.5 border"></select>
                    </div>
                </div>
                <div class="mt-6 flex items-center justify-end gap-3">
                    <button onclick="closeEditModal()" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200">Annuleren</button>
                    <button onclick="saveEditTask()" class="px-5 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700">Opslaan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div id="categoryModal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div class="absolute inset-0 modal-backdrop" onclick="closeCategoryModal()"></div>
        <div class="relative bg-white w-full max-w-2xl mx-4 rounded-2xl shadow-2xl border border-slate-200">
            <div class="bg-indigo-700 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between">
                <h3 class="text-lg font-bold">Categorieën beheren</h3>
                <button onclick="closeCategoryModal()" class="text-indigo-100 hover:text-white">✕</button>
            </div>
            <div class="p-6">
                <div id="categoryList" class="space-y-3"></div>
                <div class="mt-6 grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
                    <div class="md:col-span-4">
                        <label class="block text-xs font-bold text-slate-700 mb-1">NIEUWE CATEGORIE</label>
                        <input type="text" id="newCategoryName" class="w-full rounded-lg border-slate-300 p-2.5 border" placeholder="Bijv. Sport">
                    </div>
                    <div class="md:col-span-2">
                        <button onclick="addCategory()" class="w-full bg-indigo-600 text-white px-4 py-2.5 rounded-lg hover:bg-indigo-700 transition font-bold">Toevoegen</button>
                    </div>
                </div>
                <div class="mt-6 flex items-center justify-end gap-3">
                    <button onclick="closeCategoryModal()" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 font-semibold hover:bg-slate-200">Annuleren</button>
                    <button onclick="saveCategories()" class="px-5 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700">Opslaan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Deze taken staan ALTIJD in de code als basis.
        const defaultTasks = [
            { id: 101, time: "06:00", name: "Tandenpoetsen & opfrissen", duration: 10, type: "Kleine Taak", completed: false },
            { id: 102, time: "06:15", name: "Gezinsontbijt klaarmaken (Verrassing vrouw)", duration: 45, type: "Relatie", completed: false },
            { id: 1, time: "19:30", name: "Woonkamer nalopen & stofzuigrobot aan", duration: 15, type: "Opruimen", completed: false },
            { id: 2, time: "19:45", name: "Keuken volledig opruimen", duration: 30, type: "Gewoonte", completed: false },
            { id: 3, time: "20:15", name: "Bedenken: hoe kan ik mijn vrouw vandaag helpen?", duration: 10, type: "Relatie", completed: false },
            { id: 4, time: "22:30", name: "Tandenpoetsen & klaarmaken voor bed", duration: 10, type: "Kleine Taak", completed: false }
        ];

        const defaultCategories = [
            { name: 'Kleine Taak', allowCheck: true, color: '' },
            { name: 'Gewoonte', allowCheck: true, color: '' },
            { name: 'Relatie', allowCheck: true, color: '' },
            { name: 'Opruimen', allowCheck: true, color: '' },
            { name: 'Focus', allowCheck: true, color: '' },
            { name: 'Rust', allowCheck: true, color: '' }
        ];
        const pastelThemes = [
            { key: 'mint', label: 'Mint', color: '#d9f7e6' },
            { key: 'sky', label: 'Sky', color: '#dbeafe' },
            { key: 'lavender', label: 'Lavender', color: '#ede9fe' },
            { key: 'peach', label: 'Peach', color: '#ffedd5' },
            { key: 'rose', label: 'Rose', color: '#ffe4e6' },
            { key: 'lemon', label: 'Lemon', color: '#fef9c3' },
            { key: 'aqua', label: 'Aqua', color: '#cffafe' },
            { key: 'lilac', label: 'Lilac', color: '#f3e8ff' },
            { key: 'sage', label: 'Sage', color: '#e2f7e1' },
            { key: 'sand', label: 'Sand', color: '#f5f5dc' }
        ];

        let serverAvailable = false;
        let tasks = [...defaultTasks];
        let categories = [...defaultCategories];
        let historyEntries = [];
        let lastResetDate = null;
        let hoveredTaskId = null;

        async function init() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('nl-NL', options);
            loadQuote();
            await loadFromServer();
            await loadCategoriesFromServer();
            await loadHistoryFromServer();
            renderCategoryOptions();
            renderTasks();
            renderHistory();
            updateTimeline();
            renderBalance();
            initSortable();
            checkDailyReset();
            scheduleMidnightReset();
            setInterval(updateTimeline, 30000);
        }

        async function loadQuote() {
            const quoteEl = document.getElementById('quoteDisplay');
            try {
                const response = await fetch(`/api/quote/random?t=${Date.now()}`, { cache: 'no-store' });
                if (!response.ok) throw new Error('Quote fetch failed');
                const data = await response.json();
                if (Array.isArray(data) && data[0]?.q && data[0]?.a) {
                    const translated = await translateToDutch(data[0].q);
                    quoteEl.textContent = `“${translated}” — ${data[0].a}`;
                    return;
                }
            } catch (error) {
                quoteEl.textContent = '“Maak vandaag bewust.”';
            }
        }

        async function translateToDutch(text) {
            try {
                const url = 'https://translate.googleapis.com/translate_a/single'
                    + '?client=gtx&sl=auto&tl=nl&dt=t&q=' + encodeURIComponent(text);
                const response = await fetch(url, { cache: 'no-store' });
                if (!response.ok) throw new Error('Translate fetch failed');
                const data = await response.json();
                const translated = Array.isArray(data?.[0])
                    ? data[0].map(part => part[0]).join('')
                    : '';
                return translated || text;
            } catch (error) {
                return text;
            }
        }

        function initSortable() {
            const el = document.getElementById('taskList');
            Sortable.create(el, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: function() {
                    const rows = Array.from(el.querySelectorAll('tr'));
                    tasks = rows.map(row => tasks.find(t => t.id === parseInt(row.getAttribute('data-id'))));
                    saveToStorage();
                }
            });
        }

        function addTask() {
            const name = document.getElementById('taskName').value;
            if (!name) return;
            const timeValue = document.getElementById('taskTime').value;
            tasks.push({
                id: Date.now(),
                time: timeValue,
                name: name,
                duration: document.getElementById('taskDuration').value,
                type: document.getElementById('taskType').value,
                completed: false
            });
            if (timeValue) {
                tasks = sortTasksByTime(tasks);
            }
            saveAndRender();
            document.getElementById('taskName').value = '';
        }

        function sortTasksByTime(list) {
            return [...list].sort((a, b) => {
                const aHasTime = Boolean(a.time);
                const bHasTime = Boolean(b.time);
                if (!aHasTime && !bHasTime) return 0;
                if (!aHasTime) return 1;
                if (!bHasTime) return -1;
                const [ah, am] = a.time.split(':').map(Number);
                const [bh, bm] = b.time.split(':').map(Number);
                const aMinutes = ah * 60 + am;
                const bMinutes = bh * 60 + bm;
                return aMinutes - bMinutes;
            });
        }

        function parseTimeToMinutes(time) {
            if (!time) return null;
            const [h, m] = time.split(':').map(Number);
            if (Number.isNaN(h) || Number.isNaN(m)) return null;
            return h * 60 + m;
        }

        function buildDisplayTasks(list) {
            const display = [];
            for (let i = 0; i < list.length; i++) {
                const current = list[i];
                display.push(current);

                const next = list[i + 1];
                if (!next) continue;
                const currentStart = parseTimeToMinutes(current.time);
                const nextStart = parseTimeToMinutes(next.time);
                const currentDuration = parseInt(current.duration, 10);
                if (currentStart === null || Number.isNaN(currentDuration) || nextStart === null) continue;
                const currentEnd = currentStart + currentDuration;
                const gap = nextStart - currentEnd;
                if (gap > 0) {
                    display.push({
                        id: `gap-${current.id}-${next.id}`,
                        isGap: true,
                        duration: gap,
                        name: 'Vrije tijd'
                    });
                }
            }

            const timed = list
                .map(task => {
                    const start = parseTimeToMinutes(task.time);
                    const duration = parseInt(task.duration, 10);
                    if (start === null || Number.isNaN(duration)) return null;
                    return { id: task.id, start, duration };
                })
                .filter(Boolean)
                .sort((a, b) => a.start - b.start);

            if (timed.length) {
                const first = timed[0];
                const last = timed[timed.length - 1];
                const lastEnd = last.start + last.duration;
                const sleepDuration = (24 * 60 - lastEnd) + first.start;
                if (sleepDuration > 0) {
                    display.push({
                        id: `sleep-${first.id}-${last.id}`,
                        isGap: true,
                        duration: sleepDuration,
                        name: 'Slaap'
                    });
                }
            }
            return display;
        }

        function formatDuration(minutes) {
            const total = parseInt(minutes, 10);
            if (Number.isNaN(total)) return '';
            const hours = Math.floor(total / 60);
            const mins = total % 60;
            if (hours && mins) return `${hours}u ${mins}m`;
            if (hours) return `${hours}u`;
            return `${mins}m`;
        }

        function formatTimeRange(time, duration) {
            if (!time) return '';
            const startMinutes = parseTimeToMinutes(time);
            const durationMinutes = parseInt(duration, 10);
            if (startMinutes === null || Number.isNaN(durationMinutes)) return formatTimeNoLeadingZero(time);
            const endMinutes = (startMinutes + durationMinutes) % (24 * 60);
            return `${formatMinutesToTime(startMinutes)} - ${formatMinutesToTime(endMinutes)}`;
        }

        function formatTimeNoLeadingZero(time) {
            const [hours, mins] = time.split(':');
            if (typeof hours === 'undefined' || typeof mins === 'undefined') return time;
            const cleanHours = String(parseInt(hours, 10));
            if (cleanHours === 'NaN') return time;
            return `${cleanHours}:${String(mins).padStart(2, '0')}`;
        }

        function formatMinutesToTime(total) {
            const hours = Math.floor(total / 60) % 24;
            const mins = total % 60;
            return `${String(hours)}:${String(mins).padStart(2, '0')}`;
        }

        function getTimedTasks() {
            return tasks
                .map(task => {
                    const start = parseTimeToMinutes(task.time);
                    const duration = parseInt(task.duration, 10);
                    if (start === null || Number.isNaN(duration)) return null;
                    return { ...task, start, end: start + duration };
                })
                .filter(Boolean)
                .sort((a, b) => a.start - b.start);
        }

        function getTimelineStartMinute(timed) {
            if (!timed.length) return 0;
            const last = timed[timed.length - 1];
            return last.end % (24 * 60);
        }

        function getRelativeMinute(minute, startMinute) {
            const dayMinutes = 24 * 60;
            return (minute - startMinute + dayMinutes) % dayMinutes;
        }

        function getTimelineWindow(timed) {
            if (!timed.length) {
                return { start: 0, end: 24 * 60, duration: 24 * 60 };
            }
            const start = timed[0].start;
            const end = timed[timed.length - 1].end;
            return { start, end, duration: Math.max(end - start, 1) };
        }

        function clampTimelinePercent(value) {
            return Math.min(98, Math.max(2, value));
        }

        function getTaskDotColor(task) {
            const category = getCategorySettings(task.type);
            const categoryColor = getCategoryColor(category.color);
            if (categoryColor) return categoryColor;
            return '#94a3b8';
        }

        function showTimelineBalloon(task, window) {
            const balloon = document.getElementById('timelineBalloon');
            const balloonDot = document.getElementById('timelineBalloonDot');
            const balloonName = document.getElementById('timelineBalloonName');
            const balloonTime = document.getElementById('timelineBalloonTime');
            const balloonType = document.getElementById('timelineBalloonType');
            if (!balloon || !balloonDot || !balloonName || !balloonTime || !balloonType) return;

            const relative = task.start - window.start;
            const topPercent = clampTimelinePercent((relative / window.duration) * 100);
            balloon.style.top = `${topPercent}%`;
            balloon.classList.remove('hidden');
            balloonName.textContent = task.name || 'Actieve taak';
            balloonTime.textContent = formatTimeRange(task.time, task.duration);
            balloonType.textContent = task.type || '';
            balloonDot.style.backgroundColor = getTaskDotColor(task);
        }

        function getBalanceColor(type) {
            if (type === 'Vrije tijd') return '#e2e8f0';
            if (type === 'Slaap') return '#c7d2fe';
            return getTaskDotColor({ type });
        }

        function renderBalance() {
            const chart = document.getElementById('balanceChart');
            const legend = document.getElementById('balanceLegend');
            if (!chart || !legend) return;

            const totals = new Map();
            const displayTasks = buildDisplayTasks(tasks);
            displayTasks.forEach(task => {
                const type = task.isGap ? task.name : (task.type || 'Onbekend');
                const duration = parseInt(task.duration, 10);
                const weight = Number.isNaN(duration) || duration <= 0 ? 1 : duration;
                totals.set(type, (totals.get(type) || 0) + weight);
            });

            const entries = Array.from(totals.entries()).sort((a, b) => b[1] - a[1]);
            if (!entries.length) {
                chart.style.background = 'conic-gradient(#e2e8f0 0deg, #e2e8f0 360deg)';
                legend.innerHTML = '<div class="text-xs text-slate-400">Geen taken</div>';
                return;
            }

            const total = entries.reduce((sum, item) => sum + item[1], 0);
            let current = 0;
            const slices = [];
            legend.innerHTML = '';

            entries.forEach(([type, value]) => {
                const color = getBalanceColor(type);
                const start = (current / total) * 360;
                current += value;
                const end = (current / total) * 360;
                slices.push(`${color} ${start}deg ${end}deg`);

                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 text-xs font-semibold text-slate-600';
                const percent = Math.round((value / total) * 100);
                row.innerHTML = `
                    <span class="balance-swatch" style="background:${color}"></span>
                    <span>${type}</span>
                    <span class="ml-auto text-slate-400">${percent}%</span>
                `;
                legend.appendChild(row);
            });

            chart.style.background = `conic-gradient(${slices.join(', ')})`;
        }

        function renderTimelineDots(timed, window) {
            const items = document.getElementById('timelineItems');
            if (!items) return;
            items.innerHTML = '';
            const height = items.clientHeight || 0;

            timed.forEach(task => {
                const relative = getRelativeMinute(task.start, window.start);
                const topPercent = clampTimelinePercent((relative / window.duration) * 100);

                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.style.top = `${topPercent}%`;
                item.title = `${formatTimeRange(task.time, task.duration)} - ${task.name}`;

                const dot = document.createElement('div');
                dot.className = 'timeline-dot';
                dot.style.backgroundColor = getTaskDotColor(task);
                dot.addEventListener('mouseenter', () => {
                    hoveredTaskId = task.id;
                    showTimelineBalloon(task, window);
                });
                dot.addEventListener('mouseleave', () => {
                    hoveredTaskId = null;
                    updateTimeline();
                });

                item.appendChild(dot);
                items.appendChild(item);
            });
        }

        function renderTimelineHours(window) {
            const hours = document.getElementById('timelineHours');
            if (!hours) return;
            hours.innerHTML = '';
            const startHour = Math.floor(window.start / 60);
            const endHour = Math.ceil(window.end / 60);
            const step = window.duration <= 6 * 60 ? 1 : 2;
            for (let hour = startHour; hour <= endHour; hour += step) {
                const absolute = hour * 60;
                const relative = absolute - window.start;
                if (relative < 0 || relative > window.duration) continue;
                const topPercent = clampTimelinePercent((relative / window.duration) * 100);
                const label = document.createElement('div');
                label.className = 'timeline-hour';
                label.style.top = `${topPercent}%`;
                label.textContent = `${(hour + 24) % 24}`;
                hours.appendChild(label);
            }
        }

        function updateTimeline() {
            const balloon = document.getElementById('timelineBalloon');
            const balloonDot = document.getElementById('timelineBalloonDot');
            const balloonName = document.getElementById('timelineBalloonName');
            const balloonTime = document.getElementById('timelineBalloonTime');
            const balloonType = document.getElementById('timelineBalloonType');
            if (!balloon || !balloonDot || !balloonName || !balloonTime || !balloonType) return;

            const now = new Date();
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            const timed = getTimedTasks();
            const window = getTimelineWindow(timed);
            const timelineSection = document.getElementById('timelineSection');
            const inWindow = timed.length && nowMinutes >= window.start && nowMinutes <= window.end;
            if (timelineSection) {
                timelineSection.classList.toggle('sleep-mode', !inWindow);
            }
            renderTimelineDots(timed, window);
            renderTimelineHours(window);

            const current = timed.find(task => nowMinutes >= task.start && nowMinutes < task.end) || null;
            if (current) {
                if (hoveredTaskId) return;
                const relativeNow = nowMinutes - window.start;
                const topPercent = clampTimelinePercent((relativeNow / window.duration) * 100);
                balloon.style.top = `${topPercent}%`;
                balloon.classList.remove('hidden');
                balloonName.textContent = current.name || 'Actieve taak';
                balloonTime.textContent = formatTimeRange(current.time, current.duration);
                balloonType.textContent = current.type || '';
                balloonDot.style.backgroundColor = getTaskDotColor(current);
            } else {
                if (!hoveredTaskId) {
                    balloon.classList.add('hidden');
                }
            }
        }

        function toggleTask(id) {
            tasks = tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t);
            saveAndRender();
        }

        function resetAllTasks() {
            tasks = tasks.map(t => ({ ...t, completed: false }));
            saveAndRender();
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            saveAndRender();
        }

        let editingTaskId = null;

        function openEditModal(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            editingTaskId = id;
            document.getElementById('editTaskTime').value = task.time || '';
            document.getElementById('editTaskName').value = task.name || '';
            document.getElementById('editTaskDuration').value = task.duration || '';
            document.getElementById('editTaskType').value = task.type || 'Kleine Taak';
            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            editingTaskId = null;
        }

        function saveEditTask() {
            if (!editingTaskId) return;
            const name = document.getElementById('editTaskName').value.trim();
            if (!name) return;
            const time = document.getElementById('editTaskTime').value;
            const duration = document.getElementById('editTaskDuration').value;
            const type = document.getElementById('editTaskType').value;

            tasks = tasks.map(t => t.id === editingTaskId ? {
                ...t,
                name,
                time,
                duration,
                type
            } : t);

            closeEditModal();
            saveAndRender();
        }

        async function loadFromServer() {
            try {
                const response = await fetch('/api/tasks', { cache: 'no-store' });
                if (!response.ok) throw new Error('Server not available');
                const data = await response.json();
                if (Array.isArray(data)) {
                    tasks = data.filter(item => item && typeof item === 'object');
                    if (tasks.length !== data.length) {
                        saveToServer();
                    }
                }
                serverAvailable = true;
            } catch (error) {
                serverAvailable = false;
            }
        }

        async function saveToServer() {
            if (!serverAvailable) return;
            try {
                const cleanTasks = tasks.filter(item => item && typeof item === 'object');
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cleanTasks)
                });
                if (!response.ok) throw new Error('Server save failed');
            } catch (error) {
                serverAvailable = false;
            }
        }

        async function loadCategoriesFromServer() {
            try {
                const response = await fetch('/api/categories', { cache: 'no-store' });
                if (!response.ok) throw new Error('Server not available');
                const data = await response.json();
                if (Array.isArray(data) && data.length) {
                    categories = normalizeCategories(data);
                } else {
                    categories = [...defaultCategories];
                }
            } catch (error) {
                categories = [...defaultCategories];
            }
        }

        async function saveCategoriesToServer() {
            if (!serverAvailable) return;
            try {
                const response = await fetch('/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(categories)
                });
                if (!response.ok) throw new Error('Server save failed');
            } catch (error) {
                serverAvailable = false;
            }
        }

        async function loadHistoryFromServer() {
            try {
                const response = await fetch('/api/history', { cache: 'no-store' });
                if (!response.ok) throw new Error('Server not available');
                const data = await response.json();
                if (data && Array.isArray(data.entries)) {
                    historyEntries = data.entries;
                    lastResetDate = data.lastResetDate || null;
                }
            } catch (error) {
                historyEntries = [];
                lastResetDate = null;
            }
        }

        async function saveHistoryToServer() {
            if (!serverAvailable) return;
            try {
                const response = await fetch('/api/history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ entries: historyEntries, lastResetDate })
                });
                if (!response.ok) throw new Error('History save failed');
            } catch (error) {
                serverAvailable = false;
            }
        }

        function showSaveStatus(message) {
            const status = document.getElementById('saveStatus');
            status.textContent = message;
            status.style.opacity = "1";
            setTimeout(() => status.style.opacity = "0", 1000);
        }

        function saveToStorage() {
            saveToServer();
            showSaveStatus(serverAvailable ? 'Opgeslagen (server)' : 'Niet opgeslagen');
        }

        function saveAndRender() {
            saveToStorage();
            renderTasks();
            updateTimeline();
            renderBalance();
        }

        function getDateKey(date = new Date()) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getYesterdayKey() {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            return getDateKey(date);
        }

        function buildHistoryEntry(dateKey) {
            const checked = tasks.filter(t => t.completed);
            const unchecked = tasks.filter(t => !t.completed);
            return {
                date: dateKey,
                checkedCount: checked.length,
                checkedTasks: checked.map(t => ({ id: t.id, name: t.name, time: t.time || '', duration: t.duration || '', type: t.type })),
                uncheckedTasks: unchecked.map(t => ({ id: t.id, name: t.name, time: t.time || '', duration: t.duration || '', type: t.type }))
            };
        }

        function checkDailyReset() {
            const todayKey = getDateKey();
            if (lastResetDate === todayKey) return;
            const targetDate = lastResetDate ? getYesterdayKey() : getYesterdayKey();
            if (!historyEntries.some(entry => entry.date === targetDate)) {
                historyEntries.unshift(buildHistoryEntry(targetDate));
                saveHistoryToServer();
                renderHistory();
            }
            tasks = tasks.map(t => ({ ...t, completed: false }));
            lastResetDate = todayKey;
            saveToServer();
            saveHistoryToServer();
            renderTasks();
            updateTimeline();
        }

        function scheduleMidnightReset() {
            const now = new Date();
            const next = new Date();
            next.setHours(24, 0, 0, 0);
            const ms = next - now;
            setTimeout(() => {
                const dateKey = getYesterdayKey();
                historyEntries.unshift(buildHistoryEntry(dateKey));
                lastResetDate = getDateKey();
                tasks = tasks.map(t => ({ ...t, completed: false }));
                saveHistoryToServer();
                saveToServer();
                renderHistory();
                renderTasks();
                updateTimeline();
                setInterval(() => {
                    const newDateKey = getYesterdayKey();
                    historyEntries.unshift(buildHistoryEntry(newDateKey));
                    lastResetDate = getDateKey();
                    tasks = tasks.map(t => ({ ...t, completed: false }));
                    saveHistoryToServer();
                    saveToServer();
                    renderHistory();
                    renderTasks();
                    updateTimeline();
                }, 24 * 60 * 60 * 1000);
            }, ms);
        }

        function renderCategoryOptions() {
            const taskSelect = document.getElementById('taskType');
            const editSelect = document.getElementById('editTaskType');
            const currentTaskValue = taskSelect.value;
            const currentEditValue = editSelect.value;
            const options = categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            taskSelect.innerHTML = options;
            editSelect.innerHTML = options;
            if (currentTaskValue) taskSelect.value = currentTaskValue;
            if (currentEditValue) editSelect.value = currentEditValue;
        }

        function normalizeCategories(data) {
            return data
                .map(item => {
                    if (typeof item === 'string') {
                        return { name: item, allowCheck: true, color: '' };
                    }
                    if (item && typeof item.name === 'string') {
                        return {
                            name: item.name,
                            allowCheck: item.allowCheck !== false,
                            color: item.color || ''
                        };
                    }
                    return null;
                })
                .filter(Boolean);
        }

        function getCategorySettings(name) {
            return categories.find(cat => cat.name === name) || { name, allowCheck: true, color: '' };
        }

        function getCategoryColor(value) {
            if (!value) return '';
            if (value.startsWith('#')) return value;
            const theme = pastelThemes.find(t => t.key === value);
            return theme ? theme.color : '';
        }

        function openCategoryModal() {
            renderCategoryManager();
            const modal = document.getElementById('categoryModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeCategoryModal() {
            const modal = document.getElementById('categoryModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('newCategoryName').value = '';
        }

        function renderCategoryManager() {
            const list = document.getElementById('categoryList');
            list.innerHTML = '';
            categories.forEach((cat, index) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-3';
                row.innerHTML = `
                    <input type="text" value="${cat.name}" data-original="${cat.name}" class="flex-1 rounded-lg border-slate-300 p-2.5 border" oninput="updateCategoryName(${index}, this.value)">
                    <label class="flex items-center gap-2 text-xs text-slate-500">
                        <input type="checkbox" ${cat.allowCheck ? 'checked' : ''} onchange="updateCategoryCheck(${index}, this.checked)">
                        Check
                    </label>
                    <select class="h-9 rounded border border-slate-300 px-2 text-xs" onchange="updateCategoryColor(${index}, this.value)">
                        <option value="">Geen kleur</option>
                        ${pastelThemes.map(theme => `<option value="${theme.key}" ${cat.color === theme.key ? 'selected' : ''}>${theme.label}</option>`).join('')}
                    </select>
                    <button onclick="removeCategory(${index})" class="text-red-400 hover:text-red-600" aria-label="Verwijder categorie">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M8.25 3a.75.75 0 01.75-.75h2a.75.75 0 01.75.75V4h3.5a.75.75 0 010 1.5h-.456l-.764 9.173A2 2 0 0111.04 16H8.96a2 2 0 01-1.99-1.827L6.206 5.5H5.75a.75.75 0 010-1.5h3.5V3zm1.5 0V4h.5V3h-.5zM8.682 5.5l.725 8.703a.5.5 0 00.5.457h1.186a.5.5 0 00.5-.457l.725-8.703H8.682z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                list.appendChild(row);
            });
        }

        function updateCategoryName(index, value) {
            categories[index].name = value;
        }

        function updateCategoryCheck(index, value) {
            categories[index].allowCheck = value;
        }

        function updateCategoryColor(index, value) {
            categories[index].color = value;
        }

        function addCategory() {
            const input = document.getElementById('newCategoryName');
            const value = input.value.trim();
            if (!value) return;
            categories.push({ name: value, allowCheck: true, color: '' });
            input.value = '';
            renderCategoryManager();
        }

        function removeCategory(index) {
            categories.splice(index, 1);
            renderCategoryManager();
        }

        function saveCategories() {
            const renameMap = new Map();
            document.querySelectorAll('#categoryList input[data-original]').forEach(input => {
                const original = input.getAttribute('data-original');
                const current = input.value.trim();
                if (original && current && original !== current) {
                    renameMap.set(original, current);
                }
            });

            categories = categories
                .map(cat => ({
                    name: cat.name.trim(),
                    allowCheck: cat.allowCheck !== false,
                    color: cat.color || ''
                }))
                .filter(cat => cat.name.length);

            const unique = new Map();
            categories.forEach(cat => {
                if (!unique.has(cat.name)) unique.set(cat.name, cat);
            });
            categories = Array.from(unique.values());
            if (!categories.length) {
                categories = [...defaultCategories];
            }
            if (renameMap.size) {
                tasks = tasks.map(task => renameMap.has(task.type)
                    ? { ...task, type: renameMap.get(task.type) }
                    : task
                );
            }
            saveCategoriesToServer();
            renderCategoryOptions();
            saveToServer();
            renderTasks();
            closeCategoryModal();
            showSaveStatus(serverAvailable ? 'Opgeslagen (server)' : 'Niet opgeslagen');
        }

        function getOverlapIds() {
            const parsed = tasks
                .map(task => {
                    if (!task.time || !task.duration) return null;
                    const [h, m] = task.time.split(':').map(Number);
                    const duration = parseInt(task.duration, 10);
                    if (Number.isNaN(h) || Number.isNaN(m) || Number.isNaN(duration)) return null;
                    const start = h * 60 + m;
                    const end = start + duration;
                    return { id: task.id, start, end };
                })
                .filter(Boolean);

            const overlapIds = new Set();
            for (let i = 0; i < parsed.length; i++) {
                for (let j = i + 1; j < parsed.length; j++) {
                    const a = parsed[i];
                    const b = parsed[j];
                    if (a.start < b.end && b.start < a.end) {
                        overlapIds.add(a.id);
                        overlapIds.add(b.id);
                    }
                }
            }
            return overlapIds;
        }

        function exportTasks() {
            const blob = new Blob([JSON.stringify(tasks, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'jeroen_dagplanning_backup.json';
            a.click();
        }

        function importTasks(event) {
            const reader = new FileReader();
            reader.onload = (e) => {
                tasks = JSON.parse(e.target.result);
                saveAndRender();
            };
            reader.readAsText(event.target.files[0]);
        }

        function renderTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            const overlapIds = getOverlapIds();
            const displayTasks = buildDisplayTasks(tasks);
            displayTasks.forEach(task => {
                if (!task || typeof task !== 'object') return;
                if (task.isGap) {
                    const gapRow = document.createElement('tr');
                    gapRow.className = 'gap-row border-b border-slate-100';
                    gapRow.innerHTML = `
                        <td class="px-4 py-3"></td>
                        <td class="px-4 py-3"></td>
                        <td class="px-6 py-3">
                            <span class="text-sm font-semibold">${task.name}</span>
                        </td>
                        <td class="px-6 py-3 text-center text-sm">${formatDuration(task.duration)}</td>
                        <td class="px-6 py-3"></td>
                        <td class="px-6 py-3 actions-col ${actionsVisible ? '' : 'hidden'}"></td>
                    `;
                    list.appendChild(gapRow);
                    return;
                }
                const row = document.createElement('tr');
                row.setAttribute('data-id', task.id);
                const overlapClass = overlapIds.has(task.id) ? 'overlap' : '';
                const baseClass = task.completed ? 'completed' : (overlapClass ? '' : 'bg-white');
                row.className = `task-row border-b border-slate-100 ${baseClass} ${overlapClass}`;
                
                const categorySettings = getCategorySettings(task.type);
                let typeClass = 'badge-small';
                if (task.type === 'Gewoonte') typeClass = 'badge-habit';
                else if (task.type === 'Focus') typeClass = 'badge-focus';
                else if (task.type === 'Opruimen') typeClass = 'badge-clean';
                else if (task.type === 'Relatie') typeClass = 'badge-relationship';

                const rowColor = (!overlapClass && categorySettings.color) ? getCategoryColor(categorySettings.color) : '';
                row.innerHTML = `
                    <td class="px-4 py-4"><div class="drag-handle">⋮⋮</div></td>
                    <td class="px-4 py-4 font-bold text-sm">${formatTimeRange(task.time, task.duration)}</td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold task-text">${task.name}</span>
                            <span class="mt-1 px-2 py-0.5 rounded text-[10px] font-bold uppercase w-max ${typeClass}">${task.type}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center text-sm">${task.duration ? task.duration + 'm' : '-'}</td>
                    <td class="px-6 py-4 text-center">
                        ${categorySettings.allowCheck ? `
                            <label class="check-label inline-flex items-center justify-center">
                                <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})" class="check-input sr-only">
                                <span class="checkmark">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                        <path fill-rule="evenodd" d="M16.704 5.29a1 1 0 010 1.42l-7.25 7.25a1 1 0 01-1.42 0L3.296 9.22a1 1 0 111.42-1.42l3.308 3.308 6.54-6.54a1 1 0 011.42 0z" clip-rule="evenodd" />
                                    </svg>
                                </span>
                            </label>
                        ` : ''}
                    </td>
                    <td class="px-6 py-4 text-right actions-col ${actionsVisible ? '' : 'hidden'}">
                        <div class="inline-flex items-center gap-3">
                            <button onclick="openEditModal(${task.id})" class="text-slate-400 hover:text-slate-600" aria-label="Bewerk">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                    <path d="M13.586 2.586a2 2 0 012.828 2.828l-8.5 8.5a1 1 0 01-.39.242l-3 1a1 1 0 01-1.262-1.262l1-3a1 1 0 01.242-.39l8.5-8.5z" />
                                    <path d="M11.5 4.5l4 4" />
                                </svg>
                            </button>
                            <button onclick="deleteTask(${task.id})" class="text-red-400 hover:text-red-600" aria-label="Verwijder">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                    <path fill-rule="evenodd" d="M8.25 3a.75.75 0 01.75-.75h2a.75.75 0 01.75.75V4h3.5a.75.75 0 010 1.5h-.456l-.764 9.173A2 2 0 0111.04 16H8.96a2 2 0 01-1.99-1.827L6.206 5.5H5.75a.75.75 0 010-1.5h3.5V3zm1.5 0V4h.5V3h-.5zM8.682 5.5l.725 8.703a.5.5 0 00.5.457h1.186a.5.5 0 00.5-.457l.725-8.703H8.682z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                if (rowColor) {
                    row.style.backgroundColor = rowColor;
                    row.querySelectorAll('td').forEach(cell => {
                        cell.style.backgroundColor = rowColor;
                    });
                }
                list.appendChild(row);
            });
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            if (list) {
                list.innerHTML = '';
                const yesterdayKey = getYesterdayKey();
                const entry = historyEntries.find(item => item.date === yesterdayKey) || historyEntries[0];
                if (!entry) {
                    list.innerHTML = '<p class="text-sm text-slate-400">Geen historie beschikbaar.</p>';
                } else {
                    const total = (entry.checkedTasks?.length || 0) + (entry.uncheckedTasks?.length || 0);
                    const statusText = total
                        ? (entry.checkedCount === total
                            ? 'Alle taken afgerond — top gedaan!'
                            : `${entry.checkedCount} van de ${total} taken afgerond`)
                        : 'Geen taken';
                    const checkedCount = entry.checkedTasks?.length || 0;
                    const uncheckedCount = entry.uncheckedTasks?.length || 0;
                    const summary = document.createElement('div');
                    summary.className = 'border border-slate-200 rounded-xl overflow-hidden bg-white';
                    summary.innerHTML = `
                        <div class="px-4 py-3 flex flex-wrap items-center gap-3 text-sm">
                            <span class="font-semibold text-slate-700">${entry.date}</span>
                            <span class="text-slate-500">${statusText}</span>
                            <span class="ml-auto flex items-center gap-3 text-xs font-semibold text-slate-600">
                                <span>Afgevinkt: ${checkedCount}</span>
                                <span>Niet afgevinkt: ${uncheckedCount}</span>
                            </span>
                        </div>
                    `;
                    list.appendChild(summary);
                }
            }

            const modalList = document.getElementById('historyModalList');
            if (!modalList) return;
            modalList.innerHTML = '';
            historyEntries.forEach((entry, index) => {
                const row = document.createElement('div');
                row.className = 'border border-slate-200 rounded-xl overflow-hidden bg-white';
                row.innerHTML = `
                    <div class="w-full flex items-center justify-between px-4 py-3">
                        <button class="flex-1 flex items-center justify-between text-left" onclick="toggleHistoryRow(${index})">
                        <div class="flex items-center gap-4">
                            <span class="text-sm font-semibold text-slate-700">${entry.date}</span>
                            <span class="text-sm text-slate-500">${(entry.checkedTasks?.length || 0) + (entry.uncheckedTasks?.length || 0) > 0
                                ? (entry.checkedCount === (entry.checkedTasks?.length || 0) + (entry.uncheckedTasks?.length || 0)
                                    ? 'Alle taken afgerond — top gedaan!'
                                    : `${entry.checkedCount} van de ${(entry.checkedTasks?.length || 0) + (entry.uncheckedTasks?.length || 0)} taken afgerond`)
                                : 'Geen taken'}
                            </span>
                        </div>
                        <svg id="historyChevron-${index}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-slate-400 transition-transform">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
                        </svg>
                        </button>
                        <button onclick="openHistoryEditModal(${index})" class="ml-3 text-slate-400 hover:text-slate-600" aria-label="Historie bewerken" title="Bewerk">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                <path d="M13.586 2.586a2 2 0 012.828 2.828l-8.5 8.5a1 1 0 01-.39.242l-3 1a1 1 0 01-1.262-1.262l1-3a1 1 0 01.242-.39l8.5-8.5z" />
                                <path d="M11.5 4.5l4 4" />
                            </svg>
                        </button>
                    </div>
                    <div id="historyBody-${index}" class="hidden px-4 pb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-xs font-bold uppercase text-slate-500 mb-2">Afgevinkt</h4>
                                <ul class="space-y-2 list-disc pl-5">
                                    ${entry.checkedTasks.map(t => `<li class=\"text-sm text-slate-700\">${t.name}</li>`).join('') || '<li class="text-sm text-slate-400">Geen taken</li>'}
                                </ul>
                            </div>
                            <div>
                                <h4 class="text-xs font-bold uppercase text-slate-500 mb-2">Niet afgevinkt</h4>
                                <ul class="space-y-2 list-disc pl-5">
                                    ${entry.uncheckedTasks.map(t => `<li class=\"text-sm text-slate-700\">${t.name}</li>`).join('') || '<li class="text-sm text-slate-400">Geen taken</li>'}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                modalList.appendChild(row);
            });
        }

        function openHistoryModal() {
            const modal = document.getElementById('historyModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            if (!modal) return;
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function toggleHistoryRow(index) {
            const body = document.getElementById(`historyBody-${index}`);
            const chevron = document.getElementById(`historyChevron-${index}`);
            if (!body || !chevron) return;
            const isHidden = body.classList.contains('hidden');
            body.classList.toggle('hidden', !isHidden);
            chevron.classList.toggle('rotate-180', isHidden);
        }

        let editingHistoryIndex = null;
        function openHistoryEditModal(index) {
            const entry = historyEntries[index];
            if (!entry) return;
            editingHistoryIndex = index;
            renderHistoryEditLists(entry);
            const modal = document.getElementById('historyEditModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            initHistorySortable();
        }

        function closeHistoryEditModal() {
            const modal = document.getElementById('historyEditModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            editingHistoryIndex = null;
        }

        function renderHistoryEditLists(entry) {
            const checkedList = document.getElementById('historyCheckedList');
            const uncheckedList = document.getElementById('historyUncheckedList');
            checkedList.innerHTML = '';
            uncheckedList.innerHTML = '';
            let orderIndex = 0;

            const renderItem = (task) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-700';
                item.setAttribute('data-name', task.name || '');
                item.setAttribute('data-time', task.time || '');
                item.setAttribute('data-order', String(orderIndex++));
                item.innerHTML = `
                    <span>${task.time ? task.time + ' • ' : ''}${task.name}</span>
                    <span class="text-xs text-slate-400">↔</span>
                `;
                return item;
            };

            (entry.checkedTasks || []).forEach(task => checkedList.appendChild(renderItem(task)));
            (entry.uncheckedTasks || []).forEach(task => uncheckedList.appendChild(renderItem(task)));
            enforceHistoryOrder();
        }

        function initHistorySortable() {
            const checkedList = document.getElementById('historyCheckedList');
            const uncheckedList = document.getElementById('historyUncheckedList');
            if (!checkedList || !uncheckedList) return;
            if (checkedList._sortable) checkedList._sortable.destroy();
            if (uncheckedList._sortable) uncheckedList._sortable.destroy();

            checkedList._sortable = Sortable.create(checkedList, {
                group: 'history-edit',
                animation: 150,
                sort: false,
                onAdd: enforceHistoryOrder
            });
            uncheckedList._sortable = Sortable.create(uncheckedList, {
                group: 'history-edit',
                animation: 150,
                sort: false,
                onAdd: enforceHistoryOrder
            });
        }

        function enforceHistoryOrder() {
            ['historyCheckedList', 'historyUncheckedList'].forEach(listId => {
                const list = document.getElementById(listId);
                if (!list) return;
                const items = Array.from(list.children);
                items.sort((a, b) => {
                    const aOrder = parseInt(a.getAttribute('data-order') || '0', 10);
                    const bOrder = parseInt(b.getAttribute('data-order') || '0', 10);
                    return aOrder - bOrder;
                });
                items.forEach(item => list.appendChild(item));
            });
        }

        function saveHistoryEdit() {
            if (editingHistoryIndex === null) return;
            const checkedTasks = Array.from(document.querySelectorAll('#historyCheckedList [data-name]')).map(item => ({
                id: Date.now() + Math.random(),
                name: item.getAttribute('data-name') || '',
                time: item.getAttribute('data-time') || '',
                duration: '',
                type: ''
            }));
            const uncheckedTasks = Array.from(document.querySelectorAll('#historyUncheckedList [data-name]')).map(item => ({
                id: Date.now() + Math.random(),
                name: item.getAttribute('data-name') || '',
                time: item.getAttribute('data-time') || '',
                duration: '',
                type: ''
            }));
            historyEntries[editingHistoryIndex] = {
                ...historyEntries[editingHistoryIndex],
                checkedTasks,
                uncheckedTasks,
                checkedCount: checkedTasks.length
            };
            saveHistoryToServer();
            renderHistory();
            closeHistoryEditModal();
            showSaveStatus(serverAvailable ? 'Opgeslagen (server)' : 'Niet opgeslagen');
        }

        window.onload = init;

        let actionsVisible = false;
        function toggleConfigPanel() {
            actionsVisible = !actionsVisible;
            document.querySelectorAll('.actions-col').forEach(el => {
                el.classList.toggle('hidden', !actionsVisible);
            });
            document.querySelectorAll('.backup-action').forEach(el => {
                el.classList.toggle('admin-hidden', !actionsVisible);
            });
            document.querySelectorAll('.admin-only').forEach(el => {
                el.classList.toggle('admin-hidden', !actionsVisible);
            });
            const addTaskPanel = document.getElementById('addTaskPanel');
            if (addTaskPanel) {
                addTaskPanel.classList.toggle('hidden', !actionsVisible);
            }
            const btn = document.getElementById('actionsToggle');
            if (btn) {
                btn.setAttribute('aria-label', actionsVisible ? 'Configuratie verbergen' : 'Configuratie tonen');
                btn.setAttribute('title', actionsVisible ? 'Configuratie verbergen' : 'Configuratie tonen');
                btn.classList.toggle('opacity-70', actionsVisible);
            }
        }
    </script>
</body>
</html>